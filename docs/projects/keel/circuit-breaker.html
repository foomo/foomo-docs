<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-projects/keel/circuit-breaker/index" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.0">
<title data-rh="true">Circuit Breaker | foomo project docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://www.foomo.org/docs/projects/keel/circuit-breaker"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Circuit Breaker | foomo project docs"><meta data-rh="true" name="description" content="Sometimes things go wrong and a service does not respond anymore. Be it because of maintainance or because the whole data center burned to the ground. In such a scenario, you might not want to wait until your request times out. This is where circuit breakers come in handy."><meta data-rh="true" property="og:description" content="Sometimes things go wrong and a service does not respond anymore. Be it because of maintainance or because the whole data center burned to the ground. In such a scenario, you might not want to wait until your request times out. This is where circuit breakers come in handy."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.foomo.org/docs/projects/keel/circuit-breaker"><link data-rh="true" rel="alternate" href="https://www.foomo.org/docs/projects/keel/circuit-breaker" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.foomo.org/docs/projects/keel/circuit-breaker" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://SUATUVZDDM-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="foomo project docs RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="foomo project docs Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="foomo project docs" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.78fe5ce6.css">
<script src="/assets/js/runtime~main.638e5c2c.js" defer="defer"></script>
<script src="/assets/js/main.1248442c.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">foomo</b></a><a class="navbar__item navbar__link" href="/docs/general">General</a><a class="navbar__item navbar__link" href="/docs/frontend">Frontend</a><a class="navbar__item navbar__link" href="/docs/backend">Backend</a><a class="navbar__item navbar__link" href="/docs/devops">DevOps</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/projects">Projects</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/blog">Blog</a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/projects">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/projects/architecture">Architecture</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/projects/cms">CMS</a><button aria-label="Expand sidebar category &#x27;CMS&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/projects/gograpple">gograpple</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/projects/gotsrpc">gotsrpc</a><button aria-label="Expand sidebar category &#x27;gotsrpc&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/projects/keel">keel</a><button aria-label="Collapse sidebar category &#x27;keel&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/projects/keel/circuit-breaker">Circuit Breaker</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/projects/pagespeed-exporter">pagespeed exporter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/projects/webgrapple">webgrapple</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/projects/keel"><span itemprop="name">keel</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Circuit Breaker</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1 id="circuit-breaker">Circuit Breaker</h1>
<p>Sometimes things go wrong and a service does not respond anymore. Be it because of maintainance or because the whole data center burned to the ground. In such a scenario, you might not want to wait until your request times out. This is where circuit breakers come in handy.</p>
<p>Simply put a circuit breaker has three different states:</p>
<p><img src="/assets/images/states-35a04af12a3c710db897e18570d5b057.jpg" width="5974" height="2678"></p>
<p>We did not re-invent the wheel (yet), but rather used an existing circuit breaker. However, we extended the functionality a bit. More on that later. For referance, here are links to the <a href="https://github.com/sony/gobreaker">underlying circuit breaker</a> and some more <a href="https://learn.microsoft.com/en-us/previous-versions/msp-n-p/dn589784(v=pandp.10)?redirectedfrom=MSDN">information on circuit breakers in general</a>.</p>
<h2 id="how-to-use">How to use</h2>
<p>In order to configure the circuit breaker there are two kinds of configuration. The &quot;base&quot; configuration using the <code>CircuitBreakerSettings</code> and optional configuration using <code>CircuitBreakerOptions</code>.</p>
<h3 id="circuitbreakersettings">CircuitBreakerSettings</h3>
<p>The settings are relatively straight forward and the same as with the underlying repository - with one exception. Our settings are missing the <code>IsSuccessful</code> field.</p>
<pre><code class="language-go" metastring="reference ">https://github.com/foomo/keel/blob/b14b59b0c4ff880827f102c08c43b1de2989367f/net/http/roundtripware/circuitbreaker.go#L27-L49
</code></pre>
<h3 id="circuitbreakeroptions">CircuitBreakerOptions</h3>
<p>Currently, there are two options one for metrics and one for somewhat advanced usage.</p>
<h4 id="metrics">Metrics</h4>
<p>The option for metrics is, again, straigth forward. When the <code>CircuitBreakerWithMetric</code> option is used the roundtripware will create a counter on the provided meter and count the number of requests.</p>
<p>The attributes added to every count are:</p>
<ul>
<li><code>previous_state</code> (String): the state of the circuit breaker <strong>before</strong> the current request. Either &quot;closed&quot;, &quot;half-open&quot; or &quot;open&quot;</li>
<li><code>current_state</code> (String): the state of the circuit breaker <strong>after</strong> the current request. Either &quot;closed&quot;, &quot;half-open&quot; or &quot;open&quot;</li>
<li><code>state_change</code> (Bool): helper containing <code>current_state</code> != <code>previous_state</code></li>
<li><code>error</code> (Bool): false if the request was not passed through or was unsuccessful</li>
</ul>
<pre><code class="language-go" metastring="reference ">https://github.com/foomo/keel/blob/b14b59b0c4ff880827f102c08c43b1de2989367f/net/http/roundtripware/circuitbreaker.go#L74-L78
</code></pre>
<h4 id="issuccessful">IsSuccessful</h4>
<p>As mentioned previously, the IsSuccessful field was removed from the basic settings. The reason is that the signature of that function was a bit limiting. As you can see below our <code>IsSuccessful</code>-function can use the request and response. Additionally, if <code>copyReqBody</code> and/or <code>copyRespBody</code> are set to true, you can even read from the respective body, without worrying about consuming the io.ReadCloser.</p>
<pre><code class="language-go" metastring="reference ">https://github.com/foomo/keel/blob/b14b59b0c4ff880827f102c08c43b1de2989367f/net/http/roundtripware/circuitbreaker.go#L93-L97
</code></pre>
<p>The ignore value that is returned alongside an error indicates whether the result of the call should be registered with the circuit breaker. For most use cases it should be set to false.</p>
<p>When the <code>IsSuccessful</code>-function returns an error (and the ignore value is set to false), the request will be counted as unsuccessful. Accordingly, a nil error paired with ignored set to false indicates a successful request.</p>
<h3 id="examples">Examples</h3>
<p>Let&#x27;s say we want to stop sending requests once we encountered three consecutive failures.</p>
<pre><code class="language-go">client := keelhttp.NewHTTPClient(
		keelhttp.HTTPClientWithRoundTripware(l,
			roundtripware.CircuitBreaker(&amp;roundtripware.CircuitBreakerSettings{
				Name:        &quot;my little circuit breaker™&quot;,
                // 2 requests can pass in half-open state &amp; it takes 2 consecutive,
                // successful requests to change to closed state
				MaxRequests: 2,
                // counts are not reset in closed state
				Interval:    0, 
                // breaker will go from open to half-open state after 30s
				Timeout:     30 * time.Second,
                // go to open state after the 3rd consecutive, unsuccessful request
				ReadyToTrip: func(counts gobreaker.Counts) bool {
					return counts.ConsecutiveFailures &gt;= 3
				},
			}),
		),
	)
</code></pre>
<p>Now lets say we see we also want to detect network problems such as a BadGateway. For this we can use the <code>IsSuccessful</code> option.</p>
<pre><code class="language-go">client := keelhttp.NewHTTPClient(
    keelhttp.HTTPClientWithRoundTripware(l,
        roundtripware.CircuitBreaker(&amp;roundtripware.CircuitBreakerSettings{
            // as before ...
        },
            roundtripware.CircuitBreakerWithIsSuccessful(
                func(err error, req *http.Request, resp *http.Response) (error, bool) {
                    if err != nil {
                        return err, false
                    }
                    if resp.StatusCode &gt;= http.StatusInternalServerError {
                        return errors.New(&quot;invalid status code&quot;), false
                    }
                    return nil, false
                }, false, false,
            ),
        ),
    ),
)
</code></pre>
<p>Lastly, let&#x27;s assume we use the client for multiple different endpoints. And we only want to base the circuit breakers state on a single endpoint, but stop request on all endpoints once the breaker changes to open. Again we can use the IsSuccessful option and ignore certain endpoints.</p>
<pre><code class="language-go">client := keelhttp.NewHTTPClient(
    keelhttp.HTTPClientWithRoundTripware(l,
        roundtripware.CircuitBreaker(&amp;roundtripware.CircuitBreakerSettings{
            // as before ...
        },
            roundtripware.CircuitBreakerWithIsSuccessful(
                func(err error, req *http.Request, resp *http.Response) (error, bool) {
                    if req.URL.Path != &quot;/important/path&quot; {
                        return err, false
                    }

                    // possibly more checks ...

                    return err, true
                }, false, false,
            ),
        ),
    ),
)
</code></pre>
<h3 id="general-advice--notes-of-caution">General advice &amp; notes of caution</h3>
<h4 id="using-ratios-in-readytotrip">Using ratios in ReadyToTrip</h4>
<p>When using ratios in ready to trip, the <code>Interval</code> should be set to a non-zero value in order to reset the counts periodically. Otherwise, after a long period of successful requests it will also take a long time to impact the ratio and trip the breaker.</p>
<pre><code class="language-go">    ReadyToTrip: func(counts gobreaker.Counts) bool {
        failureRatio := float64(counts.TotalFailures) / float64(counts.Requests)
        return counts.Requests &gt;= 3 &amp;&amp; failureRatio &gt;= 0.6
    },
</code></pre></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/foomo/foomo-docs/tree/main/foomo/docs/projects/keel/circuit-breaker/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/projects/keel"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">keel</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/projects/pagespeed-exporter"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">pagespeed exporter</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#how-to-use" class="table-of-contents__link toc-highlight">How to use</a><ul><li><a href="#circuitbreakersettings" class="table-of-contents__link toc-highlight">CircuitBreakerSettings</a></li><li><a href="#circuitbreakeroptions" class="table-of-contents__link toc-highlight">CircuitBreakerOptions</a></li><li><a href="#examples" class="table-of-contents__link toc-highlight">Examples</a></li><li><a href="#general-advice--notes-of-caution" class="table-of-contents__link toc-highlight">General advice &amp; notes of caution</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">github</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/foomo" target="_blank" rel="noopener noreferrer" class="footer__link-item">https://github.com/foomo</a></li></ul></div><div class="col footer__col"><div class="footer__title">legal</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/etc/imprint">Imprint</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">© 2024 bestbytes</div></div></div></footer></div>
</body>
</html>